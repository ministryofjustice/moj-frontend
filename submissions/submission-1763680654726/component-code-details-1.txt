{
  "componentCodeLanguage": "JavaScript",
  "componentCodeLanguageOther": "",
  "componentCode": "import ModalDialog from './modal-dialog.js'\r\n\r\nfunction TimeoutWarning($module) {\r\n    this.$module = $module\r\n    this.$dialog = $module.querySelector('.govuk-timeout-warning__dialog')\r\n    this.$fallbackElement = document.querySelector('.govuk-timeout-warning-fallback')\r\n    this.modalDialog = new ModalDialog(this.$dialog).init({\r\n        onClose: this.dialogClose.bind(this),\r\n        onDialogNotSupported: this.dialogFallback.bind(this),\r\n    })\r\n    this.timers = []\r\n    // UI countdown timer specific markup\r\n    this.$countdown = $module.querySelector('.govuk-timeout-warning__timer')\r\n    this.$accessibleCountdown = $module.querySelector('.govuk-timeout-warning__at-timer')\r\n    // UI countdown specific settings\r\n    this.idleMinutesBeforeTimeOut = $module.getAttribute('data-minutes-idle-timeout') ? $module.getAttribute('data-minutes-idle-timeout') : 25\r\n    this.timeOutRedirectUrl = $module.getAttribute('data-url-redirect') ? $module.getAttribute('data-url-redirect') : 'timeout'\r\nthis.extendSessionUrl = $module.getAttribute('data-url-extend') ? $module.getAttribute('data-url-extend') : 'extend'\r\n    this.minutesTimeOutModalVisible = $module.getAttribute('data-minutes-modal-visible') ? $module.getAttribute('data-minutes-modal-visible') : 5\r\n    this.timerText = $module.getAttribute('data-timer-text') ? $module.getAttribute('data-timer-text') : 'Your session will be reset in '\r\n    this.timerExtraText = $module.getAttribute('data-timer-extra-text') ? $module.getAttribute('data-timer-extra-text') : ''\r\n    this.timerRedirectText = $module.getAttribute('data-timer-redirect-text') ? $module.getAttribute('data-timer-redirect-text') : 'You are about to be redirected'\r\n}\r\n\r\n// Initialise component\r\nTimeoutWarning.prototype.init = function() {\r\n    // Check for module and dialog\r\n    if (!this.$module || !this.modalDialog) {\r\n        return\r\n    }\r\n\r\n    // Start watching for idleness\r\n    this.countIdleTime()\r\n\r\n    if (window.history.pushState) {\r\n        this.disableBackButtonWhenOpen()\r\n    }\r\n}\r\n\r\n// Count idle time (user not interacting with page)\r\n// Reset idle time counter when user interacts with the page\r\n// If user is idle for specified time period, open timeout warning as dialog\r\nTimeoutWarning.prototype.countIdleTime = function() {\r\n    var debounce\r\n    var idleTime\r\n    var milliSecondsBeforeTimeOut = this.idleMinutesBeforeTimeOut * 60000\r\n\r\n    // As user interacts with the page, keep resetting the timer\r\n    window.onload = resetIdleTime.bind(this)\r\n    window.onmousemove = resetIdleTime.bind(this)\r\n    window.onmousedown = resetIdleTime.bind(this) // Catches touchscreen presses\r\n    window.onclick = resetIdleTime.bind(this) // Catches touchpad clicks\r\n    window.onkeypress = resetIdleTime.bind(this)\r\n    window.onkeyup = resetIdleTime.bind(this) // Catches Android keypad presses\r\n\r\n    function resetIdleTime() {\r\n        if (!this.isDialogOpen()) {\r\n            // As user has interacted with the page, reset idle time\r\n            clearTimeout(idleTime)\r\n            clearTimeout(debounce)\r\n\r\n            function idleTimer() {\r\n                this.extendTimeOnServer();\r\n                idleTime = setTimeout(this.openDialog.bind(this), milliSecondsBeforeTimeOut)\r\n            }\r\n\r\n            debounce = setTimeout(idleTimer.bind(this), 3000);\r\n        }\r\n    }\r\n}\r\n\r\nTimeoutWarning.prototype.openDialog = function() {\r\n    this.modalDialog.open();\r\n    this.startUiCountdown()\r\n\r\n    if (window.history.pushState) {\r\n        window.history.pushState('', '') // This updates the History API to enable state to be \"popped\" to detect browser navigation for disableBackButtonWhenOpen\r\n    }\r\n}\r\n\r\nTimeoutWarning.prototype.dialogFallback = function() {\r\n    this.$fallbackElement.style.display = 'block'\r\n}\r\n\r\n// Starts a UI countdown timer. If timer is not cancelled before 0\r\n// reached + 4 seconds grace period, user is redirected.\r\nTimeoutWarning.prototype.startUiCountdown = function() {\r\n    this.clearTimers() // Clear any other modal timers that might have been running\r\n    var $module = this\r\n    var $countdown = this.$countdown\r\n    var $accessibleCountdown = this.$accessibleCountdown\r\n    var minutes = this.minutesTimeOutModalVisible\r\n    var timerRunOnce = false\r\n    var timers = this.timers\r\n    var seconds = 60 * minutes\r\n\r\n    $countdown.innerText = minutes + ' minute' + (minutes > 1 ? 's' : '');\r\n\r\n    (function runTimer() {\r\n        var minutesLeft = parseInt(seconds / 60, 10)\r\n        var secondsLeft = parseInt(seconds % 60, 10)\r\n        var timerExpired = minutesLeft < 1 && secondsLeft < 1\r\n\r\n        var minutesText = minutesLeft > 0 ? '<span class=\"tabular-numbers\">' + minutesLeft + '</span> minute' + (minutesLeft > 1 ? 's' : '') + '' : ' '\r\n        var secondsText = secondsLeft >= 1 ? ' <span class=\"tabular-numbers\">' + secondsLeft + '</span> second' + (secondsLeft > 1 ? 's' : '') + '' : ''\r\n        var atMinutesNumberAsText = ''\r\n        var atSecondsNumberAsText = ''\r\n\r\n        try {\r\n            atMinutesNumberAsText = this.numberToWords(minutesLeft) // Attempt to convert numerics into text as iOS VoiceOver ccassionally stalled when encountering numbers\r\n            atSecondsNumberAsText = this.numberToWords(secondsLeft)\r\n        } catch (e) {\r\n            atMinutesNumberAsText = minutesLeft\r\n            atSecondsNumberAsText = secondsLeft\r\n        }\r\n\r\n        var atMinutesText = minutesLeft > 0 ? atMinutesNumberAsText + ' minute' + (minutesLeft > 1 ? 's' : '') + '' : ''\r\n        var atSecondsText = secondsLeft >= 1 ? ' ' + atSecondsNumberAsText + ' second' + (secondsLeft > 1 ? 's' : '') + '' : ''\r\n\r\n        // Below string will get read out by screen readers every time the timeout refreshes (every 15 secs. See below).\r\n        // Please add additional information in the modal body content or in below extraText which will get announced to AT the first time the time out opens\r\n        var text = document.createElement('p')\r\n        var timerText = document.createTextNode($module.timerText)\r\n        text.appendChild(timerText);\r\n\r\n        var countdown = document.createElement('span');\r\n        countdown.setAttribute('class', 'countdown');\r\n        countdown.innerHTML = ' ' + minutesText + secondsText + '.'\r\n        text.appendChild(countdown);\r\n\r\n        var atText = $module.timerText + ' ' + atMinutesText\r\n        if (atSecondsText) {\r\n            if (minutesLeft > 0) {\r\n                atText += ' and'\r\n            }\r\n            atText += atSecondsText + '.'\r\n        } else {\r\n            atText += '.'\r\n        }\r\n\r\n        if ($module.timerExtraText) {\r\n            var extraText = document.createElement('p')\r\n            extraText.innerText = $module.timerExtraText\r\n        }\r\n\r\n        if (timerExpired) {\r\n            $accessibleCountdown.innerText = $module.timerRedirectText\r\n            setTimeout($module.redirect.bind($module), 1000)\r\n        } else {\r\n            seconds--\r\n\r\n            $countdown.innerText = ''\r\n            $countdown.appendChild(text)\r\n            if (extraText) $countdown.appendChild(extraText)\r\n\r\n            if (minutesLeft < 1 && secondsLeft < 20) {\r\n                $accessibleCountdown.setAttribute('aria-live', 'assertive')\r\n            }\r\n\r\n            if (!timerRunOnce) {\r\n                setTimeout(() => { // Ensures text is read out just after modal opens\r\n                    $accessibleCountdown.innerText = atText + ' ' + $module.timerExtraText\r\n                    timerRunOnce = true\r\n                }, 1000)\r\n            } else if (secondsLeft % 15 === 0) {\r\n                // Update screen reader friendly content every 15 secs\r\n                $accessibleCountdown.innerText = atText\r\n            }\r\n\r\n            // JS doesn't allow resetting timers globally so timers need to be retained for resetting.\r\n            timers.push(setTimeout(runTimer, 1000))\r\n        }\r\n    })()\r\n}\r\n\r\nTimeoutWarning.prototype.saveLastFocusedEl = function() {\r\n    this.$lastFocusedEl = document.activeElement\r\n    if (!this.$lastFocusedEl || this.$lastFocusedEl === document.body) {\r\n        this.$lastFocusedEl = null\r\n    } else if (document.querySelector) {\r\n        this.$lastFocusedEl = document.querySelector(':focus')\r\n    }\r\n}\r\n\r\n// Set focus back on last focused el when modal closed\r\nTimeoutWarning.prototype.setFocusOnLastFocusedEl = function() {\r\n    if (this.$lastFocusedEl) {\r\n        window.setTimeout(function() {\r\n            this.$lastFocusedEl.focus()\r\n        }, 0)\r\n    }\r\n}\r\n\r\n\r\nTimeoutWarning.prototype.isDialogOpen = function() {\r\n    return this.modalDialog.isOpen();\r\n}\r\n\r\nTimeoutWarning.prototype.dialogClose = function() {\r\n    if (!this.isDialogOpen()) {\r\n        this.clearTimers()\r\n        this.extendTimeOnServer();\r\n    }\r\n}\r\n\r\n// Clears modal timer\r\nTimeoutWarning.prototype.clearTimers = function() {\r\n    for (var i = 0; i < this.timers.length; i++) {\r\n        clearTimeout(this.timers[i])\r\n    }\r\n}\r\n\r\n}\r\n\r\nexport default TimeoutWarning\r\n",
  "componentCodeUsage": " The behaviour of the component is set using data-attributes.  The following attributes can be set (default values are shown in square brackets):\r\n * `data-minutes-idle-timeout` [25] - number of minutes of inactivity before modal is shown\r\n * `data-minutes-modal-visible` [5] - number of minutes the modal is shown for (length of countdown)\r\n * `data-url-redirect` [timeout] - url that the user is redirected to if there is no interaction\r\n * `data-url-extend` [extend] - url that a GET request will be sent to when user requests more time\r\n * `data-timer-text` [Your session will be reset in] - text preceding the countdown, announced every time the countdown updates for screenreader users\r\n * `data-timer-extra-text` [This is to protect your data] - text following the countdown, will only be read once\r\n * `data-timer-redirect-text` [You are about to be redirected] - text announced to screenreader users just prior to redirection\r\n\r\nInitialise the timeout warning as follows\r\n```\r\n const $timeoutWarning = document.querySelector('[data-module=\"govuk-timeout-warning\"]');\r\n new TimeoutWarning($timeoutWarning).init()\r\n```"
}