{
  "componentCodeLanguage": "JavaScript",
  "componentCodeLanguageOther": "",
  "componentCode": "import axios from 'axios'\r\nimport { hide, show, pluralize } from '../helpers'\r\nimport sanitizeHtml from 'sanitize-html'\r\n\r\nconst doneTypingInterval = 500 // time in ms, 500ms to make search work fairly quickly but avoid too many DB requests\r\nconst screenReaderMessageDelay = 1000 // wait before updating the screenreader message, to avoid interrupting queue\r\nlet typingTimer\r\nlet ariaText\r\nlet proceedingMatches = []\r\nlet noMatchCount = 0\r\nlet previousSearchTerm = null\r\nlet containSimilarWords = false\r\n\r\nasync function searchResults (host, searchTerm, excludeCodes) {\r\n  const url = `${host}/proceeding_types/searches`\r\n  const response = await axios({\r\n    accept: 'application/json',\r\n    responseType: 'json',\r\n    method: 'post',\r\n    url,\r\n    data: {\r\n      search_term: searchTerm,\r\n      excluded_codes: excludeCodes\r\n    }\r\n  })\r\n  const data = response.data.data\r\n  return updateMatchCounters(data, searchTerm)\r\n}\r\n\r\nfunction setMatchAndCount (data = [], searchTerm = null) {\r\n  noMatchCount = 0\r\n  proceedingMatches = data\r\n  previousSearchTerm = searchTerm\r\n}\r\n\r\nfunction substrInArrayOfWords (wordArray1, wordArray2) {\r\n  const matches1 = wordArray1.map(substr => !!wordArray2.find(w => w.includes(substr)))\r\n  const matches2 = wordArray2.map(substr => !!wordArray1.find(w => w.includes(substr)))\r\n  return matches1.includes(true) || matches2.includes(true)\r\n}\r\n\r\nfunction checkSimilarWords (searchTerm) {\r\n  if (searchTerm && previousSearchTerm) {\r\n    const inputLower = searchTerm.toLowerCase().split(/\\s+/)\r\n    const previousLower = previousSearchTerm.toLowerCase().split(/\\s+/)\r\n    containSimilarWords = substrInArrayOfWords(inputLower, previousLower)\r\n  }\r\n}\r\n\r\nfunction updateMatchCounters (data, searchTerm) {\r\n  checkSimilarWords(searchTerm)\r\n\r\n  if (data && data.length) {\r\n    setMatchAndCount(data, searchTerm)\r\n  } else if (!data || !containSimilarWords) {\r\n    setMatchAndCount()\r\n  } else if (proceedingMatches.length) {\r\n    noMatchCount++\r\n    if (noMatchCount > 3) setMatchAndCount()\r\n  }\r\n\r\n  return proceedingMatches\r\n}\r\n\r\n// Calls search only when the typing timer expires\r\nasync function doneTyping () {\r\n  const host = document.querySelector('#exclude_codes').getAttribute('data-uri').trim()\r\n  const inputText = document.querySelector('#proceeding-search-input').value.trim()\r\n  const excludeCodes = document.querySelector('#exclude_codes').value.trim()\r\n\r\n  if (inputText.length > 2) {\r\n    hideProceeedingsItems()\r\n    const results = await searchResults(host, inputText, excludeCodes)\r\n    showResults(results, inputText)\r\n  } else {\r\n    ariaText = 'No text entered.'\r\n    updateMatchCounters()\r\n    hideProceeedingsItems()\r\n  }\r\n  setTimeout(() => { document.querySelector('#screen-reader-messages').innerHTML = sanitizeHtml(ariaText) }, screenReaderMessageDelay)\r\n}\r\n\r\n// Add event listeners for the user typing in the search box and clearing the search\r\nfunction searchOnUserInput (searchInputBox) {\r\n  searchInputBox.addEventListener('keyup', (event) => {\r\n    clearTimeout(typingTimer)\r\n    typingTimer = setTimeout(doneTyping, doneTypingInterval)\r\n  })\r\n\r\n  searchInputBox.addEventListener('keydown', () => clearTimeout(typingTimer))\r\n\r\n  document\r\n    .querySelector('#clear-proceeding-search')\r\n    .addEventListener('click', () => {\r\n      searchInputBox.value = ''\r\n      deselectPreviousProceedingItem()\r\n      hideProceeedingsItems()\r\n      setTimeout(() => { document.querySelector('#screen-reader-messages').innerHTML = 'Search box has been cleared.' }, screenReaderMessageDelay)\r\n    })\r\n}\r\n\r\nfunction deselectPreviousProceedingItem () {\r\n  const selected = document.querySelector('input:checked')\r\n  if (selected !== null) { selected.checked = false }\r\n}\r\n\r\n// Find the existing hidden proceeding type items\r\n// If they are one of the search matches returned from the V1 api, remove the hidden class\r\n// and highlight the search terms in the item text\r\nfunction showResults (results, inputText) {\r\n  if (results.length > 0) {\r\n    deselectPreviousProceedingItem()\r\n    const codes = results.map(obj => obj.ccms_code)\r\n    let shown = 0\r\n    let proceedingsContainer = document.querySelector('.govuk-radios') // with MP flag on\r\n    if (proceedingsContainer == null) { proceedingsContainer = document.querySelector('#proceeding-list') } // with MP flag off\r\n    codes.forEach((code, idx) => {\r\n      // const element = $('#' + code)\r\n      const element = document.getElementById(code)\r\n\r\n      // if LFA returns a valid proceeding (e,g, SCA) but the feature flag for those\r\n      // proceedings is turned off, then codes will only contain those proceeding types\r\n      // that are not filtered out by the LegalFramework::ProceedingTypes::All service,\r\n      // so we just ignore them here if they aren't in the list\r\n      if (element == null) { return }\r\n\r\n      shown++ // increment the count if this code is actually shown to the user\r\n      // We want to highlight anything in the label or hint text that\r\n      // matches the user's search criteria\r\n      const label = element.querySelector('label')\r\n      const hint = element.querySelector('.govuk-hint')\r\n\r\n      // Remove any existing highlighting\r\n      label.innerHTML = label.innerHTML.replace(/<mark class=\"highlight\">/gi, '')\r\n      label.innerHTML = label.innerHTML.replace(/<\\/mark>/gi, '')\r\n      hint.innerHTML = hint.innerHTML.replace(/<mark class=\"highlight\">/gi, '')\r\n      hint.innerHTML = hint.innerHTML.replace(/<\\/mark>/gi, '')\r\n\r\n      // Highlight any text that matches the user's input\r\n      const terms = inputText.split(' ')\r\n      terms.forEach((term, index) => {\r\n        if (index === 0) {\r\n          const regExp = RegExp(term.trim(), 'gi')\r\n          label.innerHTML = label.innerHTML.replace(regExp, '<mark class=\"highlight\">$&</mark>')\r\n          hint.innerHTML = hint.innerHTML.replace(regExp, '<mark class=\"highlight\">$&</mark>')\r\n        } else {\r\n          const regExp = RegExp(`(?<=(</mark>))( ?${term.trim()})`, 'gi')\r\n          label.innerHTML = label.innerHTML.replace(regExp, '<mark class=\"highlight\">$&</mark>')\r\n          hint.innerHTML = hint.innerHTML.replace(regExp, '<mark class=\"highlight\">$&</mark>')\r\n        }\r\n      })\r\n      // move to top of list, but after previously added elements\r\n      proceedingsContainer.insertBefore(element, proceedingsContainer.children[idx])\r\n      // show hidden proceedings item\r\n      show(element)\r\n    })\r\n    // once we have looped over all returned codes, check if any were shown to the user\r\n    // and set the appropriate ariaText and show/hide the no-proceedings found element\r\n    if (shown > 0) {\r\n      // the below alerts screen reader users that results appeared on the page\r\n      const pluralizedMatches = pluralize(codes.length, 'match', 'matches')\r\n      ariaText = `${codes.length} ${pluralizedMatches} found for ${inputText}, use tab to move to options`\r\n      show(document.querySelector('#proceeding-list'))\r\n      hide(document.querySelector('.no-proceeding-items'))\r\n    } else {\r\n      showNoResults(inputText)\r\n    }\r\n  } else {\r\n    showNoResults(inputText)\r\n  }\r\n}\r\n\r\nfunction showNoResults (inputText) {\r\n  hide(document.querySelector('#proceeding-list'))\r\n  show(document.querySelector('.no-proceeding-items'))\r\n  ariaText = `No results found matching ${inputText}`\r\n}\r\n\r\n// Hide any search results and the 'no results found' text\r\nfunction hideProceeedingsItems () {\r\n  document\r\n    .querySelectorAll('.proceeding-item')\r\n    .forEach(item => hide(item))\r\n\r\n  hide(document.querySelector('.no-proceeding-items'))\r\n  show(document.querySelector('#proceeding-list'))\r\n}\r\n\r\nfunction disableBackButton () {\r\n  window.history.pushState(null, document.title, window.location.href)\r\n  window.addEventListener('popstate', function (event) {\r\n    window.history.pushState(null, document.title, window.location.href)\r\n  })\r\n}\r\n\r\nif (window.location.href.includes('proceedings_types')) {\r\n  disableBackButton()\r\n}\r\n\r\n// If the proceedings type search box appears on the page, call the searchOnUserInput function\r\ndocument.addEventListener('DOMContentLoaded', event => {\r\n  hide(document.querySelector('#proceeding-list'))\r\n  const searchInputBox = document.querySelector('#proceeding-search-input')\r\n  if (searchInputBox) searchOnUserInput(searchInputBox)\r\n})\r\n\r\nexport { searchResults, searchOnUserInput, showResults }",
  "componentCodeUsage": ""
}